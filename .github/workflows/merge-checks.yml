name: Merge Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  merge-readiness:
    name: Check Merge Readiness
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR is up to date with base branch
        id: check-updated
        run: |
          git fetch origin ${{ github.base_ref }}
          BEHIND=$(git rev-list --count HEAD..origin/${{ github.base_ref }})

          if [ "$BEHIND" -gt 0 ]; then
            echo "behind=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è PR is $BEHIND commits behind ${{ github.base_ref }}"
          else
            echo "behind=false" >> $GITHUB_OUTPUT
            echo "‚úÖ PR is up to date with ${{ github.base_ref }}"
          fi

      - name: Check for merge conflicts
        id: check-conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
            echo "conflicts=true" >> $GITHUB_OUTPUT
            echo "‚ùå Merge conflicts detected"
          else
            echo "conflicts=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No merge conflicts"
          fi

      - name: Comment PR with merge status
        uses: actions/github-script@v7
        with:
          script: |
            const behind = '${{ steps.check-updated.outputs.behind }}' === 'true';
            const conflicts = '${{ steps.check-conflicts.outputs.conflicts }}' === 'true';

            let status = '‚úÖ Ready to merge!';
            let details = '';

            if (behind) {
              status = '‚ö†Ô∏è Update required';
              details += '\n‚ö†Ô∏è This PR is behind the base branch. Please update it.\n';
            }

            if (conflicts) {
              status = '‚ùå Conflicts detected';
              details += '\n‚ùå Merge conflicts detected. Please resolve them.\n';
            }

            const comment = `## üîÄ Merge Status: ${status}

            ${details}

            ${!behind && !conflicts ? '‚úÖ This PR is ready to be merged!' : ''}

            ---

            **Checklist:**
            - ${behind ? '‚ùå' : '‚úÖ'} Up to date with base branch
            - ${conflicts ? '‚ùå' : '‚úÖ'} No merge conflicts
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Merge Status')
            );

            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Fail if conflicts exist
        if: steps.check-conflicts.outputs.conflicts == 'true'
        run: |
          echo "‚ùå Merge conflicts must be resolved before merging"
          exit 1
